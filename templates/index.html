<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Netunna REDE Splitter v3</title>
  <style>
    body {
      font-family: "Inter","Roboto",Arial,sans-serif;
      background:#f6f7fb; color:#333; margin:0;
    }

    header {
      background:#ff6d00; color:#fff; padding:18px 28px;
      box-shadow:0 2px 6px rgba(0,0,0,.15);
      display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px;
    }

    header h1 { margin:0; font-size:24px; letter-spacing:.3px; }
    header small { display:block; font-size:14px; opacity:.9; margin-top:2px; }

    .status-indicador {
      display:flex; align-items:center; gap:8px;
      background:rgba(255,255,255,.15); padding:6px 12px;
      border-radius:20px; font-size:14px; font-weight:500; white-space:nowrap;
    }

    .status-indicador span { width:10px; height:10px; border-radius:50%; display:inline-block; }
    .ativo span { background:#00d24b; }
    .parado span { background:#ff4444; }
    .desconhecido span { background:#ffbb00; }

    main {
      display:grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap:20px; padding:25px;
    }

    section {
      background:#fff; border-radius:10px; padding:20px;
      box-shadow:0 3px 6px rgba(0,0,0,.08);
      display:flex; flex-direction:column; transition:all .25s ease;
      min-width:0;
    }

    h2 {
      color:#ff6d00; font-size:18px; margin:0 0 10px;
      border-bottom:2px solid #ff6d00; padding-bottom:6px;
    }

    button {
      background:#ff6d00; color:#fff; border:none; border-radius:6px;
      padding:7px 12px; font-size:14px; cursor:pointer; margin-right:6px;
      transition:background .2s ease;
    }
    button:hover { background:#e55f00; }

    table {
      width:100%; border-collapse:collapse; margin:0; border-radius:6px; overflow:hidden;
    }

    th, td {
      padding:8px 10px; border:1px solid #e0e0e0;
      text-align:left; font-size:14px;
    }

    th { background:#ff9100; color:#fff; }
    tr:nth-child(even) { background:#fafafa; }

    .ok { color:green; font-weight:bold; }
    .erro { color:#c00; font-weight:bold; }

    footer {
      text-align:center; font-size:13px; color:#777; padding:15px;
      background:#fff; border-top:1px solid #eee;
    }

    /* === Rolagem e largura controlada === */
    .scroll-box {
      border:1px solid #eee;
      border-radius:6px;
      overflow:auto;
      max-height:260px;
      margin-top:10px;
    }

    .scroll-box::-webkit-scrollbar { height:8px; width:8px; }
    .scroll-box::-webkit-scrollbar-thumb { background:#ccc; border-radius:4px; }
    .scroll-box:hover::-webkit-scrollbar-thumb { background:#999; }

    .mono { font-family: ui-monospace, Consolas, "Courier New", monospace; }

    /* === Contadores === */
    .table-count {
      font-size:13px;
      color:#666;
      margin-top:6px;
      text-align:right;
      font-style:italic;
    }

    /* === Lotes === */
    .lote-grupo {
      background:#fdfdfd; border-radius:8px; margin-top:15px;
      box-shadow:0 1px 4px rgba(0,0,0,.08); overflow:hidden;
    }

    .lote-header {
      background:#fff5ef; padding:10px 15px;
      display:flex; justify-content:space-between; align-items:center;
      cursor:pointer; border-bottom:1px solid #ffe0c2;
    }

    .lote-header h3 { color:#ff6d00; font-size:15px; margin:0; }
    .toggle-btn { background:none; border:none; font-size:22px; color:#ff6d00; cursor:pointer; font-weight:bold; }

    .lote-content { display:none; animation:fadeIn .25s ease-in; padding:0 10px 10px; }

    .resumo-output { font-weight:bold; color:#444; margin:10px 0 15px; }

    @keyframes fadeIn { from { opacity:0; transform:translateY(-3px); } to { opacity:1; transform:translateY(0); } }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>üß© Netunna REDE Splitter v3</h1>
      <small>Processamento Autom√°tico, Valida√ß√£o e Logs</small>
    </div>
    <div id="statusBar" class="status-indicador desconhecido">
      <span></span> <b>Verificando...</b>
    </div>
  </header>

  <main>
    <!-- INPUT -->
    <section>
      <h2>üìÇ Arquivos Enviados</h2>
      <div>
        <button onclick="loadFiles()">üîÑ Atualizar Lista</button>
      </div>
      <div class="scroll-box">
        <table id="inputTable">
          <thead>
            <tr><th>Arquivo</th><th>Data/Hora de Envio</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="inputCount" class="table-count"></div>
    </section>

    <!-- OUTPUT -->
    <section>
      <h2>üì¶ Arquivos Gerados</h2>
      <div class="resumo-output" id="outputSummary">üìä Nenhum lote processado ainda.</div>
      <div>
        <button onclick="loadFiles()">üîÑ Atualizar</button>
        <button onclick="downloadAll()">‚¨áÔ∏è Baixar ZIPs por NSA</button>
      </div>
      <div id="outputContainer"></div>
    </section>

    <!-- LOGS -->
    <section>
      <h2>üßæ Hist√≥rico de Processamentos</h2>
      <div class="scroll-box">
        <table id="logTable">
          <thead>
            <tr>
              <th>Data/Hora</th>
              <th>Arquivo</th>
              <th>Tipo</th>
              <th>Total Trailer</th>
              <th>Total Processado</th>
              <th>Status</th>
              <th>Detalhe</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="logCount" class="table-count"></div>
    </section>
  </main>

  <footer>
    ¬© Netunna Automations ‚Äî REDE Splitter v3 | Atualiza√ß√£o autom√°tica a cada 30s
  </footer>

  <script>
    const HEARTBEAT_MS = 3 * 60 * 1000;

    function parseBRDateTime(s) {
      if (!s) return null;
      const m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})\s+(\d{2}):(\d{2}):(\d{2})$/);
      if (!m) return null;
      const [_, dd, mm, yyyy, HH, MM, SS] = m;
      return new Date(yyyy, mm - 1, dd, HH, MM, SS);
    }

    function formatRelativo(msDiff) {
      if (!msDiff) return "‚Äî";
      const s = Math.floor(msDiff / 1000);
      if (s < 60) return `${s}s`;
      const m = Math.floor(s / 60);
      const r = s % 60;
      return `${m}m ${r}s`;
    }

    function inferStatusFromScan(scan) {
      let lastTs = null;
      if (scan?.input?.length) {
        scan.input.forEach(item => {
          const dt = parseBRDateTime(item.data_hora);
          if (dt && (!lastTs || dt > lastTs)) lastTs = dt;
        });
      }
      const now = new Date();
      const delta = lastTs ? now - lastTs : null;
      const ativo = delta != null && delta <= HEARTBEAT_MS;
      return { ativo, delta };
    }

    function pintarStatus({ ativo, fallback = false, delta = null }) {
      const barra = document.getElementById("statusBar");
      if (ativo) {
        barra.className = "status-indicador ativo";
        const extra = fallback ? " (agente)" : "";
        const info = delta ? ` ‚Ä¢ √öltima atividade: h√° ${formatRelativo(delta)}` : "";
        barra.innerHTML = `<span></span> üü¢ Ativo${extra}${info}`;
      } else {
        barra.className = "status-indicador parado";
        const info = delta ? ` ‚Ä¢ √öltima atividade: h√° ${formatRelativo(delta)}` : "";
        barra.innerHTML = `<span></span> üî¥ Parado${info}`;
      }
    }

    async function atualizarStatusComFallback(scan) {
      const barra = document.getElementById("statusBar");
      try {
        const res = await fetch("/api/status");
        const data = await res.json();
        const ok = data.status?.toLowerCase() === "ativo" || data.online || data.ok;
        if (ok) {
          pintarStatus({ ativo: true, fallback: false });
          return;
        }
        const { ativo, delta } = inferStatusFromScan(scan || {});
        pintarStatus({ ativo, fallback: true, delta });
      } catch {
        const { ativo, delta } = inferStatusFromScan(scan || {});
        pintarStatus({ ativo, fallback: true, delta });
      }
    }

    async function loadFiles() {
      try {
        const resScan = await fetch("/api/scan");
        const scan = await resScan.json();

        await atualizarStatusComFallback(scan);

        // === INPUT ===
        const tbodyIn = document.querySelector("#inputTable tbody");
        tbodyIn.innerHTML = "";
        if (!scan.input?.length) {
          tbodyIn.innerHTML = `<tr><td colspan="2" style="text-align:center;">Nenhum arquivo enviado.</td></tr>`;
        } else {
          scan.input.forEach(item => {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td class="mono">${item.nome}</td><td>${item.data_hora}</td>`;
            tbodyIn.appendChild(tr);
          });
        }
        document.getElementById("inputCount").textContent = `üìä Exibindo ${scan.input?.length || 0} registro${scan.input?.length === 1 ? "" : "s"}.`;

        // === OUTPUT ===
        const outputContainer = document.getElementById("outputContainer");
        outputContainer.innerHTML = "";
        const summary = document.getElementById("outputSummary");

        if (!scan.output?.length) {
          outputContainer.innerHTML = `<p style="text-align:center;">Nenhum arquivo gerado.</p>`;
          summary.textContent = "üìä Nenhum lote processado ainda.";
        } else {
          const grupos = {};
          scan.output.forEach(item => {
            const lote = item.lote || "NSA_000";
            if (!grupos[lote]) grupos[lote] = [];
            grupos[lote].push(item);
          });

          summary.textContent = `üìä ${Object.keys(grupos).length} lotes processados ‚Äî total de ${scan.output.length} arquivos gerados.`;

          Object.keys(grupos)
            .sort()
            .forEach(lote => {
              const grupoDiv = document.createElement("div");
              grupoDiv.classList.add("lote-grupo");

              const header = document.createElement("div");
              header.classList.add("lote-header");
              header.innerHTML = `<h3>üì¶ ${lote}</h3><button class="toggle-btn" onclick="toggleLote(this)">+</button>`;

              const content = document.createElement("div");
              content.classList.add("lote-content");
              content.innerHTML = `
