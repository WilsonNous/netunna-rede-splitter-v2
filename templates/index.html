<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Netunna REDE Splitter v3</title>
  <style>
    /* =============================
       üåê ESTILO GERAL
    ============================== */
    body {
      font-family: "Inter", "Roboto", Arial, sans-serif;
      background: #f6f7fb;
      color: #333;
      margin: 0;
    }

    header {
      background: #ff6d00;
      color: white;
      padding: 18px 28px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }

    header h1 {
      margin: 0;
      font-size: 24px;
      letter-spacing: 0.5px;
    }

    header small {
      display: block;
      font-size: 14px;
      opacity: 0.9;
      margin-top: 4px;
    }

    /* Indicador de status */
    .status-indicador {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255,255,255,0.15);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
    }

    .status-indicador span {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
    }

    .ativo span { background: #00ff55; }
    .parado span { background: #ff4444; }
    .desconhecido span { background: #ffbb00; }

    main {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: 20px;
      padding: 25px;
    }

    section {
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
    }

    section:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.12);
    }

    h2 {
      color: #ff6d00;
      font-size: 18px;
      margin-top: 0;
      margin-bottom: 10px;
      border-bottom: 2px solid #ff6d00;
      padding-bottom: 5px;
    }

    button {
      background: #ff6d00;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 7px 12px;
      font-size: 14px;
      cursor: pointer;
      margin-right: 6px;
      transition: background 0.2s ease;
    }

    button:hover {
      background: #e55f00;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      border-radius: 6px;
      overflow: hidden;
    }

    th, td {
      padding: 8px;
      border: 1px solid #e0e0e0;
      text-align: left;
      font-size: 14px;
    }

    th {
      background: #ff9100;
      color: white;
    }

    tr:nth-child(even) {
      background: #fafafa;
    }

    .ok { color: green; font-weight: bold; }
    .erro { color: red; font-weight: bold; }

    footer {
      text-align: center;
      font-size: 13px;
      color: #777;
      padding: 15px;
      background: #fff;
      border-top: 1px solid #eee;
    }

    /* =============================
       üì¶ BLOCO DE LOTE AGRUPADO
    ============================== */
    .lote-grupo {
      background: #fdfdfd;
      border-radius: 8px;
      margin-top: 15px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      overflow: hidden;
    }

    .lote-header {
      background: #fff5ef;
      padding: 10px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      border-bottom: 1px solid #ffe0c2;
    }

    .lote-header h3 {
      color: #ff6d00;
      font-size: 15px;
      margin: 0;
    }

    .toggle-btn {
      background: none;
      border: none;
      font-size: 22px;
      color: #ff6d00;
      cursor: pointer;
      font-weight: bold;
    }

    .lote-content {
      display: none;
      animation: fadeIn 0.25s ease-in;
      padding: 0 10px 10px;
    }

    .resumo-output {
      font-weight: bold;
      color: #444;
      margin: 10px 0 15px;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-3px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>üß© Netunna REDE Splitter v3</h1>
      <small>Processamento Autom√°tico, Valida√ß√£o e Logs</small>
    </div>
    <div id="statusBar" class="status-indicador desconhecido">
      <span></span> <b>Verificando...</b>
    </div>
  </header>

  <main>
    <section>
      <h2>üìÇ Arquivos Enviados</h2>
      <div>
        <button onclick="loadFiles()">üîÑ Atualizar Lista</button>
      </div>
      <table id="inputTable">
        <thead>
          <tr><th>Arquivo</th><th>Data/Hora de Envio</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section>
      <h2>üì¶ Arquivos Gerados</h2>
      <div class="resumo-output" id="outputSummary">üìä Nenhum lote processado ainda.</div>
      <div>
        <button onclick="loadFiles()">üîÑ Atualizar</button>
        <button onclick="downloadAll()">‚¨áÔ∏è Baixar ZIPs por NSA</button>
      </div>
      <div id="outputContainer"></div>
    </section>

    <section>
      <h2>üßæ Hist√≥rico de Processamentos</h2>
      <table id="logTable">
        <thead>
          <tr>
            <th>Data/Hora</th>
            <th>Arquivo</th>
            <th>Tipo</th>
            <th>Total Trailer</th>
            <th>Total Processado</th>
            <th>Status</th>
            <th>Detalhe</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <footer>
    ¬© Netunna Automations ‚Äî REDE Splitter v3 | Atualiza√ß√£o autom√°tica a cada 30s
  </footer>

  <script>
    async function atualizarStatus() {
      const barra = document.getElementById("statusBar");
      try {
        const res = await fetch("/api/status");
        const data = await res.json();

        if (data.status === "ativo" || data.online || data.ok) {
          barra.className = "status-indicador ativo";
          barra.innerHTML = `<span></span> üü¢ Ativo`;
        } else {
          barra.className = "status-indicador parado";
          barra.innerHTML = `<span></span> üî¥ Parado`;
        }
      } catch (err) {
        barra.className = "status-indicador desconhecido";
        barra.innerHTML = `<span></span> ‚ö†Ô∏è Sem resposta`;
      }
    }

    async function loadFiles() {
      try {
        await atualizarStatus();

        const resStatus = await fetch('/api/status');
        const data = await resStatus.json();

        const resScan = await fetch('/api/scan');
        const scan = await resScan.json();

        // === INPUT ===
        const tbodyIn = document.querySelector('#inputTable tbody');
        tbodyIn.innerHTML = '';
        if (!scan.input || scan.input.length === 0) {
          tbodyIn.innerHTML = `<tr><td colspan="2" style="text-align:center;">Nenhum arquivo enviado.</td></tr>`;
        } else {
          scan.input.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${item.nome}</td><td>${item.data_hora}</td>`;
            tbodyIn.appendChild(tr);
          });
        }

        // === OUTPUT AGRUPADO ===
        const outputContainer = document.getElementById("outputContainer");
        outputContainer.innerHTML = '';
        const summary = document.getElementById("outputSummary");

        if (!scan.output || scan.output.length === 0) {
          outputContainer.innerHTML = `<p style="text-align:center;">Nenhum arquivo gerado.</p>`;
          summary.textContent = "üìä Nenhum lote processado ainda.";
        } else {
          const grupos = {};
          scan.output.forEach(item => {
            const lote = item.lote || "NSA_000";
            if (!grupos[lote]) grupos[lote] = [];
            grupos[lote].push(item);
          });

          const totalLotes = Object.keys(grupos).length;
          const totalArquivos = scan.output.length;
          summary.textContent = `üìä ${totalLotes} lotes processados ‚Äî total de ${totalArquivos} arquivos gerados.`;

          Object.keys(grupos).sort().forEach(lote => {
            const grupoDiv = document.createElement("div");
            grupoDiv.classList.add("lote-grupo");

            const header = document.createElement("div");
            header.classList.add("lote-header");
            header.innerHTML = `
              <h3>üì¶ ${lote}</h3>
              <button class="toggle-btn" onclick="toggleLote(this)">+</button>
            `;

            const content = document.createElement("div");
            content.classList.add("lote-content");
            content.innerHTML = `
              <table>
                <thead>
                  <tr><th>Arquivo</th><th>Data/Hora</th><th>A√ß√£o</th></tr>
                </thead>
                <tbody>
                  ${grupos[lote].map(a => `
                    <tr>
                      <td>${a.nome}</td>
                      <td>${a.data_hora}</td>
                      <td><a href="/api/download/${encodeURIComponent(a.nome)}" target="_blank" style="color:#ff6d00;text-decoration:none;">‚¨áÔ∏è Baixar</a></td>
                    </tr>`).join('')}
                </tbody>
              </table>
            `;

            grupoDiv.appendChild(header);
            grupoDiv.appendChild(content);
            outputContainer.appendChild(grupoDiv);
          });
        }

        // === LOGS ===
        loadLogs(data.logs);

      } catch (err) {
        console.error("Erro ao carregar dados:", err);
      }
    }

    function toggleLote(btn) {
      const content = btn.parentElement.nextElementSibling;
      const isVisible = content.style.display === "block";
      content.style.display = isVisible ? "none" : "block";
      btn.textContent = isVisible ? "+" : "‚àí";
    }

    async function downloadAll() {
      try {
        const res = await fetch('/api/download-all');
        const data = await res.json();

        if (data.zips && data.zips.length > 0) {
          alert(`Foram gerados ${data.zips.length} arquivos ZIP por NSA.`);
          data.zips.forEach(zip => {
            const a = document.createElement("a");
            a.href = `/zips/${zip}`;
            a.download = zip;
            a.click();
          });
        } else {
          alert("Nenhum ZIP foi gerado.");
        }
      } catch (err) {
        alert("Erro ao gerar os ZIPs.");
        console.error(err);
      }
    }

    function loadLogs(logs) {
      const tbody = document.querySelector('#logTable tbody');
      tbody.innerHTML = '';
      if (!logs || logs.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;">Nenhum log encontrado.</td></tr>`;
        return;
      }
      logs.slice().reverse().forEach(l => {
        const tr = document.createElement('tr');
        const statusClass = l.status === 'OK' ? 'ok' : 'erro';
        tr.innerHTML = `
          <td>${l.data_hora}</td>
          <td>${l.arquivo}</td>
          <td>${l.tipo}</td>
          <td>${l.total_trailer}</td>
          <td>${l.total_processado}</td>
          <td class="${statusClass}">${l.status}</td>
          <td>${l.detalhe}</td>`;
        tbody.appendChild(tr);
      });
    }

    loadFiles();
    setInterval(loadFiles, 30000);
  </script>
</body>
</html>
