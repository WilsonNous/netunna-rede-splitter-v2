<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Netunna REDE Splitter v3</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f6f9; margin: 0; }
    header { background: #ff6d00; color: white; padding: 15px 25px; }
    h1 { margin: 0; font-size: 24px; }
    main { padding: 20px; }
    section { background: #fff; border-radius: 8px; padding: 15px; margin-bottom: 20px;
              box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    h2 { color: #333; font-size: 18px; margin-top: 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: left; font-size: 14px; }
    th { background: #ff9100; color: white; }
    tr:nth-child(even) { background: #fafafa; }
    button { background: #ff6d00; color: white; border: none; padding: 6px 14px;
             border-radius: 4px; cursor: pointer; }
    button:hover { background: #ff9100; }
    .ok { color: green; font-weight: bold; }
    .erro { color: red; font-weight: bold; }
    footer { text-align: center; font-size: 13px; color: #777; margin-top: 20px; padding: 10px; }
  </style>
</head>
<body>
  <header>
    <h1>üß© Netunna REDE Splitter v3</h1>
    <small>Processamento, Valida√ß√£o e Logs</small>
  </header>

  <main>
    <section>
      <h2>üìÇ Arquivos de Entrada</h2>
      <button onclick="loadFiles()">üîÑ Atualizar Lista</button>
      <table id="inputTable">
        <thead><tr><th>Arquivo</th><th>A√ß√µes</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <section>
      <h2>üì¶ Arquivos Gerados</h2>
      <button onclick="loadOutput()">üîÑ Atualizar</button>
      <button onclick="downloadAll()">‚¨áÔ∏è Baixar Todos (ZIP)</button>
      <table id="outputTable">
        <thead><tr><th>Arquivo</th><th>A√ß√µes</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <section>
      <h2>üßæ Hist√≥rico de Processamentos</h2>
      <table id="logTable">
        <thead>
          <tr>
            <th>Data/Hora</th>
            <th>Arquivo</th>
            <th>Tipo</th>
            <th>Total Trailer</th>
            <th>Total Processado</th>
            <th>Status</th>
            <th>Detalhe</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <footer>
    ¬© Netunna Automations ‚Äî REDE Splitter v3 | Atualiza√ß√£o di√°ria autom√°tica √†s 03:00
  </footer>

  <script>
    async function loadFiles() {
      const res = await fetch('/api/status');
      const data = await res.json();

      const resScan = await fetch('/api/scan');
      const scan = await resScan.json();

      const tbody = document.querySelector('#inputTable tbody');
      tbody.innerHTML = '';
      scan.input.forEach(f => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${f}</td>
                        <td><button onclick="processFile('${f}')">‚ñ∂ Processar</button></td>`;
        tbody.appendChild(tr);
      });

      const tbodyOut = document.querySelector('#outputTable tbody');
      tbodyOut.innerHTML = '';
      scan.output.forEach(f => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${f}</td>
                        <td><button onclick="downloadFile('${f}')">‚¨áÔ∏è Baixar</button></td>`;
        tbodyOut.appendChild(tr);
      });

      loadLogs(data.logs);
    }

    async function processFile(filename) {
      try {
        const res = await fetch('/api/process', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ filename })
        });
    
        const data = await res.json();
        if (data.erro) {
          alert('‚ùå Erro ao processar: ' + data.erro);
          return;
        }
    
        alert('‚úÖ ' + (data.mensagem || 'Processamento conclu√≠do.'));
    
        // Aguarda alguns segundos para o servidor atualizar o log
        setTimeout(loadFiles, 2000);
      } catch (err) {
        console.error('Erro no processamento:', err);
        alert('‚ö†Ô∏è Falha ao processar o arquivo.');
      }
    }

    async function loadOutput() {
      loadFiles();
    }

    async function downloadFile(filename) {
      window.location.href = `/api/download/${filename}`;
    }

    async function downloadAll() {
      window.location.href = '/api/download-all';
    }

    function loadLogs(logs) {
      const tbody = document.querySelector('#logTable tbody');
      tbody.innerHTML = '';
      if (!logs || logs.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;">Nenhum log encontrado.</td></tr>`;
        return;
      }
      logs.reverse().forEach(l => {
        const tr = document.createElement('tr');
        const statusClass = l.status === 'OK' ? 'ok' : 'erro';
        tr.innerHTML = `
          <td>${l.data_hora}</td>
          <td>${l.arquivo}</td>
          <td>${l.tipo}</td>
          <td>${l.total_trailer}</td>
          <td>${l.total_processado}</td>
          <td class="${statusClass}">${l.status}</td>
          <td>${l.detalhe}</td>`;
        tbody.appendChild(tr);
      });
    }

    loadFiles();
    setInterval(loadFiles, 30000);
  </script>
</body>
</html>
