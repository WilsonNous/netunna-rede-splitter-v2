<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Netunna REDE Splitter v3</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f6f9; margin: 0; }
    header { background: #ff6d00; color: white; padding: 15px 25px; }
    h1 { margin: 0; font-size: 24px; }
    main { padding: 20px; }
    section { background: #fff; border-radius: 8px; padding: 15px; margin-bottom: 20px;
              box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    h2 { color: #333; font-size: 18px; margin-top: 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: left; font-size: 14px; }
    th { background: #ff9100; color: white; }
    tr:nth-child(even) { background: #fafafa; }
    .ok { color: green; font-weight: bold; }
    .erro { color: red; font-weight: bold; }
    footer { text-align: center; font-size: 13px; color: #777; margin-top: 20px; padding: 10px; }

    /* Agrupamento por lote */
    .lote-grupo { background: #fff; border-radius: 8px; padding: 10px 15px; margin-bottom: 20px;
                  box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
    .lote-grupo h3 { color: #ff6d00; font-size: 16px; margin: 5px 0 10px; }
    .resumo-output { font-weight: bold; color: #333; margin-bottom: 10px; }
  </style>
</head>
<body>
  <header>
    <h1>üß© Netunna REDE Splitter v3</h1>
    <small>Processamento Autom√°tico, Valida√ß√£o e Logs</small>
  </header>

  <main>
    <section>
      <h2>üìÇ Arquivos Enviados (Input)</h2>
      <button onclick="loadFiles()">üîÑ Atualizar Lista</button>
      <table id="inputTable">
        <thead><tr><th>Arquivo</th><th>Data/Hora de Envio</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <section>
      <h2>üì¶ Arquivos Gerados (Output)</h2>
      <div class="resumo-output" id="outputSummary">üìä Nenhum lote processado ainda.</div>
      <button onclick="loadFiles()">üîÑ Atualizar</button>
      <button onclick="downloadAll()">‚¨áÔ∏è Baixar ZIPs por NSA</button>
      <div id="outputContainer"></div>
    </section>

    <section>
      <h2>üßæ Hist√≥rico de Processamentos</h2>
      <table id="logTable">
        <thead>
          <tr>
            <th>Data/Hora</th>
            <th>Arquivo</th>
            <th>Tipo</th>
            <th>Total Trailer</th>
            <th>Total Processado</th>
            <th>Status</th>
            <th>Detalhe</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <footer>
    ¬© Netunna Automations ‚Äî REDE Splitter v3 | Atualiza√ß√£o autom√°tica a cada 30s
  </footer>

  <script>
    async function loadFiles() {
      try {
        const resStatus = await fetch('/api/status');
        const data = await resStatus.json();

        const resScan = await fetch('/api/scan');
        const scan = await resScan.json();

        // === INPUT ===
        const tbodyIn = document.querySelector('#inputTable tbody');
        tbodyIn.innerHTML = '';
        if (!scan.input || scan.input.length === 0) {
          tbodyIn.innerHTML = `<tr><td colspan="2" style="text-align:center;">Nenhum arquivo enviado.</td></tr>`;
        } else {
          scan.input.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${item.nome}</td><td>${item.data_hora}</td>`;
            tbodyIn.appendChild(tr);
          });
        }

        // === OUTPUT AGRUPADO ===
        const outputContainer = document.getElementById("outputContainer");
        outputContainer.innerHTML = '';
        const summary = document.getElementById("outputSummary");

        if (!scan.output || scan.output.length === 0) {
          outputContainer.innerHTML = `<p style="text-align:center;">Nenhum arquivo gerado.</p>`;
          summary.textContent = "üìä Nenhum lote processado ainda.";
        } else {
          const grupos = {};
          scan.output.forEach(item => {
            const lote = item.lote || "NSA_000";
            if (!grupos[lote]) grupos[lote] = [];
            grupos[lote].push(item);
          });

          const totalLotes = Object.keys(grupos).length;
          const totalArquivos = scan.output.length;
          summary.textContent = `üìä ${totalLotes} lotes processados ‚Äî total de ${totalArquivos} arquivos gerados.`;

          Object.keys(grupos).sort().forEach(lote => {
            const grupoDiv = document.createElement("div");
            grupoDiv.classList.add("lote-grupo");
            grupoDiv.innerHTML = `<h3>üì¶ ${lote}</h3>
              <table>
                <thead>
                  <tr><th>Arquivo</th><th>Data/Hora</th><th>A√ß√£o</th></tr>
                </thead>
                <tbody>
                  ${grupos[lote].map(a => `
                    <tr>
                      <td>${a.nome}</td>
                      <td>${a.data_hora}</td>
                      <td><a href="/api/download/${encodeURIComponent(a.nome)}" target="_blank" style="color:#ff6d00;text-decoration:none;">‚¨áÔ∏è Baixar</a></td>
                    </tr>`).join('')}
                </tbody>
              </table>`;
            outputContainer.appendChild(grupoDiv);
          });
        }

        // === LOGS ===
        loadLogs(data.logs);

      } catch (err) {
        console.error("Erro ao carregar dados:", err);
      }
    }

    async function downloadAll() {
      try {
        const res = await fetch('/api/download-all');
        const data = await res.json();

        if (data.zips && data.zips.length > 0) {
          alert(`Foram gerados ${data.zips.length} arquivos ZIP por NSA.`);
          data.zips.forEach(zip => {
            const a = document.createElement("a");
            a.href = `/zips/${zip}`;
            a.download = zip;
            a.click();
          });
        } else {
          alert("Nenhum ZIP foi gerado.");
        }
      } catch (err) {
        alert("Erro ao gerar os ZIPs.");
        console.error(err);
      }
    }

    function loadLogs(logs) {
      const tbody = document.querySelector('#logTable tbody');
      tbody.innerHTML = '';
      if (!logs || logs.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;">Nenhum log encontrado.</td></tr>`;
        return;
      }
      logs.slice().reverse().forEach(l => {
        const tr = document.createElement('tr');
        const statusClass = l.status === 'OK' ? 'ok' : 'erro';
        tr.innerHTML = `
          <td>${l.data_hora}</td>
          <td>${l.arquivo}</td>
          <td>${l.tipo}</td>
          <td>${l.total_trailer}</td>
          <td>${l.total_processado}</td>
          <td class="${statusClass}">${l.status}</td>
          <td>${l.detalhe}</td>`;
        tbody.appendChild(tr);
      });
    }

    loadFiles();
    setInterval(loadFiles, 30000);
  </script>
</body>
</html>
