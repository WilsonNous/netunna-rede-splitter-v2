<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Netunna REDE Splitter v5.3</title>
  <style>
    body {
      font-family: "Inter","Roboto",Arial,sans-serif;
      background:#f6f7fb; color:#333; margin:0;
      animation: fadeInBody 0.5s ease-in;
    }
    @keyframes fadeInBody { from { opacity:0; transform:translateY(-10px); } to { opacity:1; transform:translateY(0); } }

    header {
      background:#ff6d00; color:#fff; padding:18px 28px;
      box-shadow:0 2px 6px rgba(0,0,0,.15);
      display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px;
    }
    header h1 { margin:0; font-size:24px; letter-spacing:.3px; }
    header small { display:block; font-size:14px; opacity:.9; margin-top:2px; }

    .status-indicador {
      display:flex; align-items:center; gap:8px;
      background:rgba(255,255,255,.15); padding:6px 12px;
      border-radius:20px; font-size:14px; font-weight:500; white-space:nowrap;
      box-shadow:inset 0 0 3px rgba(0,0,0,0.1);
    }
    .status-indicador span { width:10px; height:10px; border-radius:50%; display:inline-block; animation:none; }
    .ativo span { background:#00d24b; animation:pulseGreen 1.5s infinite; }
    .parado span { background:#ff4444; animation:pulseRed 1.5s infinite; }

    @keyframes pulseGreen {
      0% { box-shadow:0 0 0 0 rgba(0,210,75,0.5); }
      70% { box-shadow:0 0 0 6px rgba(0,210,75,0); }
      100% { box-shadow:0 0 0 0 rgba(0,210,75,0); }
    }
    @keyframes pulseRed {
      0% { box-shadow:0 0 0 0 rgba(255,68,68,0.5); }
      70% { box-shadow:0 0 0 6px rgba(255,68,68,0); }
      100% { box-shadow:0 0 0 0 rgba(255,68,68,0); }
    }

    main {
      display:grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap:20px; padding:25px;
    }
    section {
      background:#fff; border-radius:10px; padding:20px;
      box-shadow:0 3px 6px rgba(0,0,0,.08);
      display:flex; flex-direction:column;
      min-width:0; overflow:hidden;
    }
    h2 { color:#ff6d00; font-size:18px; margin:0 0 10px; border-bottom:2px solid #ff6d00; padding-bottom:6px; }

    button {
      background:#ff6d00; color:#fff; border:none; border-radius:6px;
      padding:7px 12px; font-size:14px; cursor:pointer; margin-right:6px;
      transition:background .2s ease, transform .1s ease;
    }
    button:hover { background:#e55f00; transform:scale(1.02); }

    table { width:100%; border-collapse:collapse; }
    th, td { padding:8px 10px; border:1px solid #e0e0e0; text-align:left; font-size:14px; }
    th {
      background:#ff9100; color:#fff;
      position: sticky; top: 0; z-index: 2;
      box-shadow:0 2px 2px rgba(0,0,0,0.05);
    }
    tr:nth-child(even) { background:#fafafa; }
    .ok { color:green; font-weight:bold; }
    .erro { color:#c00; font-weight:bold; }
    .mono { font-family: ui-monospace, Consolas, "Courier New", monospace; }

    footer {
      text-align:center; font-size:13px; color:#777; padding:15px 10px 25px;
      background:#fff; border-top:1px solid #eee; position:relative;
    }
    #clock { font-weight:500; color:#444; font-size:13px; margin-top:6px; }

    .scroll-box {
      border:1px solid #eee; border-radius:6px; overflow:auto;
      max-height:260px; margin-top:10px;
    }
    .scroll-box::-webkit-scrollbar,
    .lote-content::-webkit-scrollbar { height:8px; width:8px; }
    .scroll-box::-webkit-scrollbar-thumb,
    .lote-content::-webkit-scrollbar-thumb { background:#ccc; border-radius:4px; }
    .scroll-box:hover::-webkit-scrollbar-thumb,
    .lote-content:hover::-webkit-scrollbar-thumb { background:#999; }

    .table-count { font-size:13px; color:#555; margin-top:6px; text-align:right; font-style:italic; }

    .lote-grupo {
      background:#fdfdfd; border-radius:8px; margin-top:15px;
      box-shadow:0 1px 4px rgba(0,0,0,.08);
      overflow:hidden; transition:background .3s ease;
    }
    .lote-grupo.open { background:#fff9f3; }
    .lote-header {
      background:#fff5ef; padding:8px 12px;
      display:flex; justify-content:space-between; align-items:center;
      cursor:pointer; border-bottom:1px solid #ffe0c2;
    }
    .lote-header h3 {
      color:#ff6d00; font-size:14px; margin:0; font-weight:600;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
      display:flex; align-items:center; gap:6px;
    }
    .badge { background:#ff9100; color:#fff; font-size:11px; padding:2px 6px; border-radius:10px; }
    .toggle-btn { background:none; border:none; font-size:20px; color:#ff6d00; cursor:pointer; font-weight:bold; transition:transform .2s ease; }
    .toggle-btn:hover { transform:scale(1.2); }
    .lote-content { display:block; overflow:hidden; max-height:0; opacity:0; transition:max-height .4s ease, opacity .4s ease; padding:0 10px; }
    .lote-content.open { opacity:1; max-height:260px; overflow:auto; padding-bottom:10px; }
    .resumo-output { font-weight:bold; color:#444; margin:10px 0 15px; }

    .versao {
      position:absolute; right:12px; bottom:8px;
      font-size:11px; color:#aaa; opacity:.6; font-style:italic;
    }

    /* === Ednna === */
    #ednna-btn {
      position: fixed; bottom: 25px; right: 25px;
      background: #ff6d00; border: none; border-radius: 50%;
      width: 60px; height: 60px; cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
      transition: transform 0.2s ease;
      z-index: 9999; overflow: hidden;
    }
    #ednna-btn:hover { transform: scale(1.1); }
    #ednna-btn img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }

    #ednna-chat {
      position: fixed; bottom: 100px; right: 25px;
      width: 320px; max-height: 430px;
      background: #fff; border-radius: 14px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.25);
      display: none; flex-direction: column;
      overflow: hidden; z-index: 9998;
      animation: fadeInChat 0.3s ease;
    }
    @keyframes fadeInChat { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    #ednna-header { background:#ff6d00; color:#fff; padding:10px 12px; display:flex; align-items:center; justify-content:space-between; }
    #ednna-header h4 { margin:0; font-size:15px; display:flex; align-items:center; gap:8px; }
    #ednna-header img { width:22px; height:22px; border-radius:50%; object-fit:cover; border:1px solid rgba(255,255,255,0.6); }
    #ednna-close { background:none; border:none; color:#fff; font-size:18px; cursor:pointer; font-weight:bold; }
    #ednna-messages { flex:1; padding:10px; overflow-y:auto; font-size:14px; display:flex; flex-direction:column; }
    .msg { margin-bottom:8px; padding:8px 10px; border-radius:8px; max-width:85%; }
    .msg.ednna { background:#fff5ef; color:#444; align-self:flex-start; }
    .msg.user { background:#ff9100; color:#fff; align-self:flex-end; }
    #ednna-input { display:flex; border-top:1px solid #eee; }
    #ednna-input input { flex:1; padding:8px; border:none; font-size:14px; outline:none; }
    #ednna-input button { background:#ff6d00; color:#fff; border:none; padding:8px 12px; cursor:pointer; transition:background .2s ease; }
    #ednna-input button:hover { background:#e55f00; }
  </style>
</head>

<body>
  <header>
    <div>
      <h1>üß© Netunna REDE Splitter v5.3</h1>
      <small>Processamento Autom√°tico, Valida√ß√£o e Logs</small>
    </div>
    <div id="statusBar" class="status-indicador desconhecido"><span></span><b>Verificando...</b></div>
  </header>

  <main>
    <section>
      <h2>üìÇ Arquivos Enviados</h2>
      <div><button onclick="loadFiles()">üîÑ Atualizar Lista</button></div>
      <div class="scroll-box">
        <table id="inputTable"><thead><tr><th>Arquivo</th><th>Data/Hora de Envio</th></tr></thead><tbody></tbody></table>
      </div>
      <div id="inputCount" class="table-count"></div>
    </section>

    <section>
      <h2>üì¶ Arquivos Gerados</h2>
      <div class="resumo-output" id="outputSummary">üìä Nenhum lote processado ainda.</div>
      <div><button onclick="loadFiles()">üîÑ Atualizar</button><button onclick="downloadAll()">‚¨áÔ∏è Baixar ZIPs por NSA</button></div>
      <div id="outputContainer"></div>
    </section>

    <section>
      <h2>üßæ Hist√≥rico de Processamentos</h2>
      <div class="scroll-box">
        <table id="logTable">
          <thead><tr><th>Data/Hora</th><th>Arquivo</th><th>Tipo</th><th>Total Trailer</th><th>Total Processado</th><th>Status</th><th>Detalhe</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="logCount" class="table-count"></div>
    </section>
  </main>

  <footer>
    ¬© Netunna Automations ‚Äî REDE Splitter v5.3 | Atualiza√ß√£o autom√°tica a cada 30s
    <div id="clock">üïí <span id="currentTime"></span> ‚Ä¢ Hor√°rio de Bras√≠lia (BRT)</div>
    <span class="versao">Build Stable</span>
  </footer>

  <!-- === Ednna Assistente === -->
  <button id="ednna-btn" title="Falar com Ednna ü§ñ"><img src="static/ednna_avatar.png" alt="Ednna" /></button>
  <div id="ednna-chat">
    <div id="ednna-header"><h4><img src="static/ednna_avatar.png" alt="Ednna"/> Ednna</h4><button id="ednna-close">√ó</button></div>
    <div id="ednna-messages"><div class="msg ednna">Ol√° üëã Sou a Ednna, assistente do Splitter!<br>Posso te ajudar com d√∫vidas sobre status, logs ou arquivos processados.</div></div>
    <div id="ednna-input"><input type="text" id="ednna-text" placeholder="Digite sua pergunta..."/><button onclick="sendEdnnaMsg()">‚û§</button></div>
  </div>

  <script>
    const HEARTBEAT_MS = 3 * 60 * 1000;

    function atualizarRelogio(){
      const agora=new Date();
      const op={timeZone:'America/Sao_Paulo',hour12:false};
      document.getElementById("currentTime").textContent=agora.toLocaleString('pt-BR',op);
    }
    atualizarRelogio(); setInterval(atualizarRelogio,60000);

    function parseBRDateTime(s){if(!s)return null;const m=s.match(/^(\d{2})\/(\d{2})\/(\d{4})\s+(\d{2}):(\d{2}):(\d{2})$/);if(!m)return null;const[_,dd,mm,yyyy,HH,MM,SS]=m;return new Date(yyyy,mm-1,dd,HH,MM,SS);}
    function formatRelativo(ms){if(!ms)return"‚Äî";const s=Math.floor(ms/1000);if(s<60)return`${s}s`;const m=Math.floor(s/60);const r=s%60;return`${m}m ${r}s`;}
    function inferStatusFromScan(scan){let lastTs=null;if(scan?.input?.length){scan.input.forEach(i=>{const d=parseBRDateTime(i.data_hora);if(d&&(!lastTs||d>lastTs))lastTs=d;});}const now=new Date();const delta=lastTs?now-lastTs:null;return{ativo:delta!=null&&delta<=HEARTBEAT_MS,delta};}
    function pintarStatus({ativo,delta=null}){const b=document.getElementById("statusBar");if(ativo){b.className="status-indicador ativo";b.innerHTML=`<span></span> üü¢ Ativo ‚Ä¢ √öltima atividade: h√° ${formatRelativo(delta)}`;}else{b.className="status-indicador parado";b.innerHTML=`<span></span> üî¥ Parado ‚Ä¢ √öltima atividade: h√° ${formatRelativo(delta)}`;}}

    async function atualizarStatusComFallback(scan){try{const r=await fetch("/api/status");const d=await r.json();const ok=d.status?.toLowerCase()==="ativo"||d.online||d.ok;if(ok){pintarStatus({ativo:true});return d.logs||[];}else{const{ativo,delta}=inferStatusFromScan(scan||{});pintarStatus({ativo,delta});return d.logs||[];}}catch{const{ativo,delta}=inferStatusFromScan(scan||{});pintarStatus({ativo,delta});return[];}}

    async function loadFiles(){
      try{
        const rs=await fetch("/api/scan");const scan=await rs.json();
        const logsStatus=await atualizarStatusComFallback(scan);

        const tbodyIn=document.querySelector("#inputTable tbody");
        tbodyIn.innerHTML="";
        if(!scan.input?.length){tbodyIn.innerHTML=`<tr><td colspan="2" style="text-align:center;">Nenhum arquivo enviado.</td></tr>`;}
        else{scan.input.forEach(i=>{const tr=document.createElement("tr");tr.innerHTML=`<td class='mono'>${i.nome}</td><td>${i.data_hora}</td>`;tbodyIn.appendChild(tr);});}
        document.getElementById("inputCount").textContent=`üìä Exibindo ${scan.input?.length||0} registros.`;

        const oc=document.getElementById("outputContainer");oc.innerHTML="";
        const s=document.getElementById("outputSummary");
        if(!scan.output?.length){oc.innerHTML=`<p style='text-align:center;'>Nenhum arquivo gerado.</p>`;s.textContent="üìä Nenhum lote processado ainda.";}
        else{
          const g={}; scan.output.forEach(i=>{const l=i.lote||"NSA_000";if(!g[l])g[l]=[];g[l].push(i);});
          s.textContent=`üìä ${Object.keys(g).length} lotes processados ‚Äî total de ${scan.output.length} arquivos.`;
          Object.keys(g).sort().forEach(l=>{
            const d=document.createElement("div");d.classList.add("lote-grupo");
            const h=document.createElement("div");h.classList.add("lote-header");
            h.innerHTML=`<h3>üì¶ ${l} <span class='badge'>${g[l].length}</span></h3><button class='toggle-btn' onclick='toggleLote(this)'>+</button>`;
            const c=document.createElement("div");c.classList.add("lote-content");
            c.innerHTML=`<table><thead><tr><th>Arquivo</th><th>Data/Hora</th><th>A√ß√£o</th></tr></thead><tbody>${g[l].map(a=>`<tr><td class='mono'>${a.nome}</td><td>${a.data_hora}</td><td><a href='/api/download/${encodeURIComponent(a.nome)}' target='_blank' style='color:#ff6d00;text-decoration:none;'>‚¨áÔ∏è Baixar</a></td></tr>`).join("")}</tbody></table>`;
            d.appendChild(h);d.appendChild(c);oc.appendChild(d);
          });
        }

        const tl=document.querySelector("#logTable tbody");tl.innerHTML="";
        const logs=scan.logs?.length?scan.logs:logsStatus;
        if(!logs?.length){tl.innerHTML=`<tr><td colspan="7" style="text-align:center;">Nenhum log encontrado.</td></tr>`;}
        else{
          logs.slice().reverse().forEach(l=>{
            const st=l.status==="OK"?"ok":"erro";
            const tr=document.createElement("tr");
            tr.innerHTML=`<td>${l.data_hora}</td><td class='mono'>${l.arquivo}</td><td>${l.tipo}</td><td>${l.total_trailer}</td><td>${l.total_processado}</td><td class='${st}'>${l.status}</td><td>${l.detalhe}</td>`;
            tl.appendChild(tr);
          });
        }
        document.getElementById("logCount").textContent=`üìä Exibindo ${logs?.length||0} registros.`;
      }catch(err){console.error("Erro:",err);document.getElementById("statusBar").innerHTML=`<span></span> ‚ö†Ô∏è Erro ao consultar API`;}
    }

    function toggleLote(b){const g=b.closest(".lote-grupo");const c=g.querySelector(".lote-content");const o=c.classList.contains("open");document.querySelectorAll(".lote-content.open").forEach(x=>{x.classList.remove("open");x.parentElement.classList.remove("open");x.previousElementSibling.querySelector("button").textContent="+";});if(!o){c.classList.add("open");g.classList.add("open");b.textContent="‚àí";}}

    async function downloadAll(){
      try{const r=await fetch("/api/download-all");const d=await r.json();
        if(d.zips?.length){
          alert(`Foram gerados ${d.zips.length} arquivos ZIP.`);
          d.zips.forEach(z=>{const a=document.createElement("a");a.href=`/zips/${z}`;a.download=z;a.click();});
        } else alert("Nenhum ZIP foi gerado.");
      }catch{alert("Erro ao gerar os ZIPs.");}
    }

    // Ednna
    const ednnaBtn=document.getElementById('ednna-btn');
    const ednnaChat=document.getElementById('ednna-chat');
    const ednnaClose=document.getElementById('ednna-close');
    const ednnaMsgs=document.getElementById('ednna-messages');
    ednnaBtn.onclick=()=>{ednnaChat.style.display=ednnaChat.style.display==='flex'?'none':'flex';};
    ednnaClose.onclick=()=>ednnaChat.style.display='none';
    function sendEdnnaMsg(){
      const input=document.getElementById('ednna-text');const text=input.value.trim();if(!text)return;
      const user=document.createElement('div');user.className='msg user';user.textContent=text;ednnaMsgs.appendChild(user);input.value='';ednnaMsgs.scrollTop=ednnaMsgs.scrollHeight;
      setTimeout(()=>{const reply=document.createElement('div');reply.className='msg ednna';reply.textContent=gerarRespostaEdnna(text);ednnaMsgs.appendChild(reply);ednnaMsgs.scrollTop=ednnaMsgs.scrollHeight;},600);
    }
    function gerarRespostaEdnna(msg){
      const t=msg.toLowerCase();
      if(t.includes("erro"))return"Verifique a se√ß√£o 'Hist√≥rico de Processamentos' para detalhes de erro.";
      if(t.includes("status"))return"O Splitter atualiza o status a cada 30 segundos automaticamente.";
      if(t.includes("download"))return"Voc√™ pode baixar os arquivos ZIPs na se√ß√£o 'Arquivos Gerados'.";
      if(t.includes("oi")||t.includes("ol√°"))return"Oi üëã Tudo bem? Como posso ajudar voc√™?";
      return"Ainda estou aprendendo! Logo poderei consultar os dados do sistema em tempo real. üòä";
    }

    loadFiles(); setInterval(loadFiles,30000);
  </script>
</body>
</html>
