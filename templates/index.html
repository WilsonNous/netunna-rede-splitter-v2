<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Netunna REDE Splitter v5.3</title>
  <style>
    body {
      font-family: "Inter","Roboto",Arial,sans-serif;
      background:#f6f7fb; color:#333; margin:0;
      animation: fadeInBody 0.5s ease-in;
    }
    @keyframes fadeInBody { from { opacity:0; transform:translateY(-10px); } to { opacity:1; transform:translateY(0); } }

    header {
      background:#ff6d00; color:#fff; padding:18px 28px;
      box-shadow:0 2px 6px rgba(0,0,0,.15);
      display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px;
    }
    header h1 { margin:0; font-size:24px; letter-spacing:.3px; }
    header small { display:block; font-size:14px; opacity:.9; margin-top:2px; }

    .status-indicador {
      display:flex; align-items:center; gap:8px;
      background:rgba(255,255,255,.15); padding:6px 12px;
      border-radius:20px; font-size:14px; font-weight:500; white-space:nowrap;
      box-shadow:inset 0 0 3px rgba(0,0,0,0.1);
    }
    .status-indicador span { width:10px; height:10px; border-radius:50%; display:inline-block; animation:none; }
    .ativo span { background:#00d24b; animation:pulseGreen 1.5s infinite; }
    .parado span { background:#ff4444; animation:pulseRed 1.5s infinite; }

    @keyframes pulseGreen {
      0% { box-shadow:0 0 0 0 rgba(0,210,75,0.5); }
      70% { box-shadow:0 0 0 6px rgba(0,210,75,0); }
      100% { box-shadow:0 0 0 0 rgba(0,210,75,0); }
    }
    @keyframes pulseRed {
      0% { box-shadow:0 0 0 0 rgba(255,68,68,0.5); }
      70% { box-shadow:0 0 0 6px rgba(255,68,68,0); }
      100% { box-shadow:0 0 0 0 rgba(255,68,68,0); }
    }

    main {
      display:flex; flex-direction:column;
      gap:20px; padding:25px;
    }
    section {
      background:#fff; border-radius:10px; padding:20px;
      box-shadow:0 3px 6px rgba(0,0,0,.08);
      display:flex; flex-direction:column;
      min-width:0; overflow:hidden;
    }
    section + section { margin-top:8px; }
    section.agente + section { margin-top:20px; }

    h2 { color:#ff6d00; font-size:18px; margin:0 0 10px; border-bottom:2px solid #ff6d00; padding-bottom:6px; }

    button {
      background:#ff6d00; color:#fff; border:none; border-radius:6px;
      padding:7px 12px; font-size:14px; cursor:pointer; margin-right:6px;
      transition:background .2s ease, transform .1s ease;
    }
    button:hover { background:#e55f00; transform:scale(1.02); }

    table { width:100%; border-collapse:collapse; }
    th, td { padding:8px 10px; border:1px solid #e0e0e0; text-align:left; font-size:14px; }
    th {
      background:#ff9100; color:#fff;
      position: sticky; top: 0; z-index: 2;
      box-shadow:0 2px 2px rgba(0,0,0,0.05);
    }
    tr:nth-child(even) { background:#fafafa; }

    .ok { color:green; font-weight:bold; }
    .erro { color:#c00; font-weight:bold; }
    .mono { font-family: ui-monospace, Consolas, "Courier New", monospace; }

    footer {
      text-align:center; font-size:13px; color:#777; padding:15px 10px 25px;
      background:#fff; border-top:1px solid #eee; position:relative;
    }
    #clock { font-weight:500; color:#444; font-size:13px; margin-top:6px; }

    .scroll-box {
      border:1px solid #eee; border-radius:6px; overflow:auto;
      max-height:260px; margin-top:10px;
    }
    .scroll-box::-webkit-scrollbar,
    .lote-content::-webkit-scrollbar { height:8px; width:8px; }
    .scroll-box::-webkit-scrollbar-thumb,
    .lote-content::-webkit-scrollbar-thumb { background:#ccc; border-radius:4px; }
    .scroll-box:hover::-webkit-scrollbar-thumb,
    .lote-content:hover::-webkit-scrollbar-thumb { background:#999; }

    .table-count { font-size:13px; color:#555; margin-top:6px; text-align:right; font-style:italic; }

    /* === üîπ Caixa do Agente Netunna === */
    section.agente {
      border-left:5px solid #00bfa5;
      background:#f4fffc;
      box-shadow:0 3px 6px rgba(0,191,165,0.2);
    }
    section.agente h2 {
      color:#00796b;
      border-bottom:2px solid #00bfa5;
    }
    section.agente button {
      background:#00bfa5;
    }
    section.agente button:hover {
      background:#00997a;
    }

    /* === Logs do Agente === */
    #agentLogs {
      background:#000;
      color:#00ff6a;
      border:1px solid #333;
      border-radius:6px;
      max-height:240px;
      overflow-y:auto;
      box-shadow:inset 0 0 8px rgba(0,0,0,0.4);
      display:none;
      margin-top:10px;
    }
    #agentLogs pre {
      font-size:12px;
      font-family:monospace;
      margin:0;
      padding:8px;
      line-height:1.3;
    }
  </style>
</head>

<body>
  <header>
    <div>
      <h1>üß© Netunna REDE Splitter v5.3</h1>
      <small>Processamento Autom√°tico, Valida√ß√£o e Logs</small>
    </div>
    <div id="statusBar" class="status-indicador desconhecido"><span></span><b>Verificando...</b></div>
  </header>

  <main>
    <!-- üîπ Se√ß√£o do Agente Netunna -->
    <section class="agente">
      <h2>ü§ñ Agente Netunna ‚Äî Execu√ß√£o Autom√°tica e Status</h2>
      <small style="color:#00796b; margin-bottom:10px;">
        Gerencia a execu√ß√£o autom√°tica do Splitter, monitorando uploads e processamento.
      </small>
      <div>
        <button onclick="executarAgente()">‚öôÔ∏è Executar Agente</button>
        <button onclick="verLogsAgente()">üß† Ver Logs do Agente</button>
        <button onclick="loadFiles()">üìú Atualizar Status</button>
      </div>

      <div id="agentLogs" class="scroll-box">
        <pre id="agentLogContent"></pre>
      </div>
    </section>

    <!-- üîπ Arquivos Enviados -->
    <section>
      <h2>üìÇ Arquivos Enviados</h2>
      <div class="scroll-box">
        <table id="inputTable"><thead><tr><th>Arquivo</th><th>Data/Hora de Envio</th></tr></thead><tbody></tbody></table>
      </div>
      <div id="inputCount" class="table-count"></div>
    </section>

    <!-- üîπ Arquivos Gerados -->
    <section>
      <h2>üì¶ Arquivos Gerados</h2>
      <div class="resumo-output" id="outputSummary">üìä Nenhum lote processado ainda.</div>
      <div>
        <button onclick="loadFiles()">üîÑ Atualizar</button>
        <button onclick="downloadAll()">‚¨áÔ∏è Baixar ZIPs por NSA</button>
        <button onclick="baixarArquivosProcessados()">‚¨áÔ∏è Baixar Arquivos Processados</button>
        <button onclick="abrirValidador()">üß© Validar Integridade</button>
      </div>
      <div id="validateResult" style="margin:8px 0; font-size:13px; color:#444;"></div>
      <div id="outputContainer"></div>
    </section>

    <!-- üîπ Hist√≥rico -->
    <section>
      <h2>üßæ Hist√≥rico de Processamentos</h2>
      <div class="scroll-box">
        <table id="logTable">
          <thead>
            <tr>
              <th>Data/Hora</th>
              <th>Arquivo</th>
              <th>Tipo</th>
              <th>Total Trailer</th>
              <th>Total Processado</th>
              <th>Integridade</th>
              <th>Detalhe</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="logCount" class="table-count"></div>
    </section>
  </main>

  <footer>
    ¬© Netunna Automations ‚Äî REDE Splitter v5.3 | Atualiza√ß√£o autom√°tica a cada 30s
    <div id="clock">üïí <span id="currentTime"></span> ‚Ä¢ Hor√°rio de Bras√≠lia (BRT)</div>
  </footer>

  <iframe id="ednna-frame" src="/static/ednna.html" title="Assistente Ednna"></iframe>

  <script>
    async function executarAgente() {
      try {
        const res = await fetch("/api/agente/run", { method: "POST" });
        const contentType = res.headers.get("content-type");
        if (contentType && contentType.includes("application/json")) {
          const data = await res.json();
          alert(data.msg || "‚úÖ Agente iniciado com sucesso!");
        } else {
          const text = await res.text();
          console.warn("Resposta n√£o JSON:", text);
          alert("‚ö†Ô∏è O servidor retornou uma resposta inesperada.");
        }
        verLogsAgente();
      } catch (err) {
        alert("Erro ao iniciar o agente: " + err);
      }
    }

    async function baixarArquivosProcessados() {
      try {
        const resp = await fetch("/api/agente/download");
        if (!resp.ok) {
          alert("‚ö†Ô∏è Erro ao gerar ZIP: " + resp.statusText);
          return;
        }
        const blob = await resp.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `netunna_output_${new Date().toISOString().slice(0,19).replace(/[:T]/g, "-")}.zip`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        alert("üì¶ Arquivos processados baixados com sucesso!");
      } catch (err) {
        console.error("Erro ao baixar ZIP:", err);
        alert("‚ùå Erro ao baixar arquivos: " + err);
      }
    }


    function verLogsAgente() {
      const box = document.getElementById("agentLogs");
      const content = document.getElementById("agentLogContent");

      if (box.style.display === "none" || box.style.display === "") {
        box.style.display = "block";
        logsInterval = setInterval(async () => {
          try {
            const res = await fetch("/api/agente/status");
            const data = await res.json();
            if (data.logs) {
              content.textContent = data.logs.join("\n");
              content.scrollTop = content.scrollHeight;
            }
          } catch (e) {
            console.warn("Erro ao buscar logs do agente:", e);
          }
        }, 4000);
      } else {
        box.style.display = "none";
        clearInterval(logsInterval);
      }
    }
  </script>

  <script src="/static/main.js"></script>
</body>
</html>
